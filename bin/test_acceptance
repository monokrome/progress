#!/usr/bin/env bash

set -e  # Terminate if any comand errors

echo Executing simple blackbox tests

CONFIG_CONTENTS='{"defaultProject": "MTC", "storage": {"backend": "sqlite3", "options": "projects.sqlite3"}}'

# Set prg location
PRG=bin/prg

[[ -f projects.sqlite3 ]] && rm projects.sqlite3

echo "${CONFIG_CONTENTS}" > progress.json

if [[ $(uname -s) == Darwin ]]; then
  shacmd="shasum -a 256"
else
  shacmd="sha256sum"
fi

# Function to verify hashes of commands
NOHASH=01ba4719
check() {
  command_string="${PRG} ${@:2}"

  echo ${command_string}
  output=$( ${command_string} ``)
  echo -n $output

  hashed=$(echo ${output} | ${shacmd} | cut -f 1 -d \ )
  echo

  if [[ $hashed != $1* ]]; then
cat<<MSG
Executing command failed: ${command}
Command was expected $1 but got $hashed
MSG
    exit 1
  fi
}

echo - Create a couple projects
check a185e342 project create -a MTC Metanic
check 996b40b5 project create -a HAP hapengine 

# Create some projects w/ abbreviations
echo - Create a few tasks
check ca218322 task create -a MTC first
check 7d0acbb1 task create -a HAP second
check b910c4b8 task create third

# Get current active task
echo - Generate project list
check 0826007b project list

echo - Generate task list
check 575536b8 task list

echo - Get active task
check 0ec647d45 task active

echo
